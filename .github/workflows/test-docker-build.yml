name: Test Docker images (on PR)
on:
  workflow_dispatch: {}
permissions: {}
jobs:
  get_changed_files:
    name: Build all modified docker images
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: Check out code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      with:
        persist-credentials: false
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@1c8e6069583811afb28f97afeaf8e7da80c6be5c
      with:
        files: docker/*/Dockerfile
        json: true
    - name: Run step if only the files listed above change
      if: steps.changed-files.outputs.any_changed == 'true'
      id: set-matrix
      env:
        CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
      run: 'echo "matrix=$(echo ${CHANGED_FILES} | sed -e ''s/\\\"/\"/g'')" >> $GITHUB_OUTPUT

        '
  build_modified_files:
    needs: get_changed_files
    name: Build Docker images on modified files
    runs-on: ubuntu-latest
    if: ${{ needs.get_changed_files.outputs.matrix != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        docker-file: ${{ fromJson(needs.get_changed_files.outputs.matrix) }}
    steps:
    - name: Cleanup disk
      run: 'sudo ls -l /usr/local/lib/

        sudo ls -l /usr/share/

        sudo du -sh /usr/local/lib/

        sudo du -sh /usr/share/

        sudo rm -rf /usr/local/lib/android

        sudo rm -rf /usr/share/dotnet

        sudo du -sh /usr/local/lib/

        sudo du -sh /usr/share/

        '
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f
    - name: Check out code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      with:
        persist-credentials: false
    - name: Build Docker image
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
      with:
        file: ${{ matrix.docker-file }}
        context: .
        push: False
