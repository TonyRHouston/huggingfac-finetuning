name: Build Docker images (scheduled)
on:
  workflow_dispatch: null
  workflow_call: null
  schedule:
  - cron: 0 1 * * *
concurrency:
  group: docker-image-builds
  cancel-in-progress: false
permissions: {}
env:
  CI_SLACK_CHANNEL: ${{ secrets.CI_DOCKER_CHANNEL }}
jobs:
  latest-cpu:
    name: Latest Peft CPU [dev]
    runs-on: ubuntu-latest
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2
    - name: Check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      with:
        persist-credentials: false
    - name: Login to DockerHub
      uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    - name: Build and Push CPU
      uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1
      with:
        context: ./docker/peft-cpu
        push: true
        tags: huggingface/peft-cpu
    - name: Post to Slack
      if: always()
      uses: huggingface/hf-workflows/.github/actions/post-slack@3f88d63d3761558a32e8e46fc2a8536e04bb2aea
      with:
        slack_channel: ${{ env.CI_SLACK_CHANNEL }}
        title: "\U0001F917 Results of the PEFT-CPU docker build"
        status: ${{ job.status }}
        slack_token: ${{ secrets.SLACK_CIFEEDBACK_BOT_TOKEN }}
  latest-cuda:
    name: Latest Peft GPU [dev]
    runs-on: ubuntu-latest
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2
    - name: Check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      with:
        persist-credentials: false
    - name: Login to DockerHub
      uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    - name: Build and Push GPU
      uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1
      with:
        context: ./docker/peft-gpu
        push: true
        tags: huggingface/peft-gpu
    - name: Post to Slack
      if: always()
      uses: huggingface/hf-workflows/.github/actions/post-slack@3f88d63d3761558a32e8e46fc2a8536e04bb2aea
      with:
        slack_channel: ${{ env.CI_SLACK_CHANNEL }}
        title: "\U0001F917 Results of the PEFT-GPU docker build"
        status: ${{ job.status }}
        slack_token: ${{ secrets.SLACK_CIFEEDBACK_BOT_TOKEN }}
